<!DOCTYPE html>
 <html lang="es" data-theme="dark">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>Visor de Jugadores - IQSCORE</title>
     <script src="https://cdn.tailwindcss.com"></script>
     <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
     <style>
         /* Estilos para tema oscuro */
         [data-theme="dark"] {
             --bg-color: #121212;
             --header-bg: linear-gradient(145deg, #1a1a2e, #16213e);
             --card-bg: #1e1e1e;
             --text-color: #ffffff;
             --text-secondary: #b0b0b0;
             --input-bg: #2d2d2d;
             --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
             --header-text: #ffffff;
             --error-bg: #2d0707;
             --error-text: #ff6b6b;
             --position-fw: #ff6b6b;
             --position-mf: #4caf50;
             --position-df: #2196f3;
             --position-gk: #ffeb3b;
             --accent-color: #4c4cff;
         }

         /* Estilos para tema claro */
         [data-theme="light"] {
             --bg-color: #f8f9fa;
             --header-bg: linear-gradient(145deg, #3357E9, #2a46c5);
             --card-bg: #ffffff;
             --text-color: #2d3748;
             --text-secondary: #4a5568;
             --input-bg: #edf2f7;
             --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
             --header-text: #ffffff;
             --error-bg: #fee2e2;
             --error-text: #b91c1c;
             --position-fw: #e53e3e;
             --position-mf: #38a169;
             --position-df: #3182ce;
             --position-gk: #d69e2e;
             --accent-color: #4c4cff;
         }

         body {
             background-color: var(--bg-color);
             color: var(--text-color);
             transition: all 0.3s ease;
             margin: 0;
             padding: 0;
             min-height: 100vh;
             display: flex;
             flex-direction: column;
             font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
         }

         .header-bg {
             background: var(--header-bg);
             box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
         }

         main {
             flex: 1;
             padding: 1.5rem;
         }

         .card {
             transition: all 0.3s ease;
             background: var(--card-bg);
             color: var(--text-color);
             border-radius: 10px;
             overflow: hidden;
             box-shadow: var(--card-shadow);
             display: flex;
             flex-direction: column;
             height: 100%;
             border: 1px solid rgba(255, 255, 255, 0.05);
         }

         .card:hover {
             transform: translateY(-5px);
             box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
         }

         .theme-switch {
             transition: all 0.3s ease;
             padding: 0.5rem;
             border-radius: 50%;
             background-color: rgba(255, 255, 255, 0.1);
             border: none;
             cursor: pointer;
             width: 40px;
             height: 40px;
             display: flex;
             align-items: center;
             justify-content: center;
         }

         .theme-switch:hover {
             background-color: rgba(255, 255, 255, 0.2);
         }

         .theme-switch i {
             color: var(--header-text);
             font-size: 1.2rem;
         }

         footer {
             background: var(--header-bg);
             color: var(--header-text);
             text-align: center;
             padding: 1rem;
             margin-top: auto;
             font-size: 0.875rem;
         }

         .selector {
             background-color: var(--input-bg);
             color: var(--text-color);
             border: 1px solid rgba(0, 0, 0, 0.1);
             padding: 0.5rem 1rem;
             border-radius: 8px;
             transition: all 0.3s ease;
             min-width: 200px;
         }

         .selector:focus {
             outline: none;
             border-color: var(--accent-color);
             box-shadow: 0 0 0 2px rgba(76, 76, 255, 0.2);
         }

         .player-photo {
             width: 80px;
             height: 80px;
             object-fit: cover;
             border-radius: 50%;
             border: 3px solid;
             margin-right: 1rem;
             flex-shrink: 0;
         }

         .position-fw { border-color: var(--position-fw); }
         .position-mf { border-color: var(--position-mf); }
         .position-df { border-color: var(--position-df); }
         .position-gk { border-color: var(--position-gk); }

         .position-tag {
             display: inline-block;
             padding: 0.25rem 0.75rem;
             border-radius: 20px;
             font-weight: 600;
             font-size: 0.75rem;
             margin-right: 0.5rem;
             margin-bottom: 0.5rem;
             background-color: rgba(0, 0, 0, 0.1);
         }

         .position-fw-bg { background-color: var(--position-fw); color: white; }
         .position-mf-bg { background-color: var(--position-mf); color: white; }
         .position-df-bg { background-color: var(--position-df); color: white; }
         .position-gk-bg { background-color: var(--position-gk); color: #1a202c; }

         .stats-grid {
             display: grid;
             grid-template-columns: repeat(2, 1fr);
             gap: 0.75rem;
             margin-top: 1rem;
         }

         .stat-item {
             background: rgba(255, 255, 255, 0.05);
             padding: 0.75rem;
             border-radius: 8px;
             text-align: center;
             transition: all 0.2s ease;
         }

         .stat-item:hover {
             transform: translateY(-2px);
             background: rgba(255, 255, 255, 0.1);
         }

         .stat-value { font-weight: 700; font-size: 1.2rem; color: var(--accent-color); }
         .stat-label { font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }

         .error-state {
             background-color: var(--error-bg);
             color: var(--error-text);
             padding: 2rem;
             border-radius: 10px;
             text-align: center;
         }

         .empty-state { padding: 2rem; text-align: center; color: var(--text-secondary); }
         .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }

         .loading-spinner { animation: spin 1s linear infinite; color: var(--accent-color); }
         @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

         /* Modal styles */
         .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
         .modal-content { background: var(--card-bg); padding: 2rem; border-radius: 12px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1); }
         .modal-close { float: right; cursor: pointer; font-size: 1.5rem; transition: all 0.2s ease; color: var(--text-secondary); }
         .modal-close:hover { color: var(--text-color); transform: scale(1.1); }

         .btn { padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
         .btn i { font-size: 0.9rem; }
         .btn-primary { background-color: var(--accent-color); color: white; }
         .btn-primary:hover { background-color: #3a3aff; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(76, 76, 255, 0.2); }
         .btn-danger { background-color: #ff4c4c; color: white; }
         .btn-danger:hover { background-color: #ff3333; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(255, 76, 76, 0.2); }
         .btn-success { background-color: #4CAF50; color: white; }
         .btn-success:hover { background-color: #3e8e41; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(76, 175, 80, 0.2); }
         .btn-secondary { background-color: var(--input-bg); color: var(--text-color); }
         .btn-secondary:hover { background-color: rgba(255, 255, 255, 0.1); transform: translateY(-2px); }

         .action-buttons { display: flex; gap: 0.75rem; margin-top: 1.5rem; }
         .action-buttons .btn { flex: 1; text-align: center; padding: 0.6rem; font-size: 0.85rem; }

         /* Player details modal */
         .player-details-header { display: flex; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
         .player-details-photo { width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 4px solid; margin-right: 1.5rem; }
         .player-details-info { flex: 1; }
         .player-details-name { font-size: 1.8rem; font-weight: 700; margin-bottom: 0.5rem; }
         .player-details-team { font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 0.5rem; }
         .player-details-position { display: inline-block; padding: 0.3rem 1rem; border-radius: 20px; font-weight: 600; margin-right: 0.5rem; }
         .player-details-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; margin: 1.5rem 0; }
         .player-details-stat { background: rgba(255, 255, 255, 0.05); padding: 1rem; border-radius: 8px; text-align: center; }
         .player-details-stat-value { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.25rem; color: var(--accent-color); }
         .player-details-stat-label { font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; }
         .player-details-section { margin-top: 1.5rem; }
         .player-details-section h3 { font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem; color: var(--accent-color); }
         .player-details-section p, .player-details-section li { line-height: 1.6; margin-bottom: 0.5rem; }
         .nationality-flag { font-size: 1.5rem; vertical-align: middle; margin-right: 0.5rem; }

         /* Form styles needed for adding title/history */
         .form-group { margin-bottom: 1.25rem; }
         .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-color); }
         .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1); background-color: var(--input-bg); color: var(--text-color); transition: all 0.3s ease; }
         .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(76, 76, 255, 0.2); }

         /* Responsive adjustments */
         @media (max-width: 768px) {
             .player-details-header { flex-direction: column; text-align: center; }
             .player-details-photo { margin-right: 0; margin-bottom: 1rem; }
             .player-details-stats { grid-template-columns: repeat(2, 1fr); }
             .action-buttons { flex-direction: column; }
         }

         /* Custom scrollbar */
         ::-webkit-scrollbar { width: 8px; height: 8px; }
         ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 10px; }
         ::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 10px; }
         ::-webkit-scrollbar-thumb:hover { background: #3a3aff; }
     </style>
 </head>
 <body>
    <header class="flex justify-between items-center p-4 header-bg shadow-lg">
        <div class="flex items-center space-x-4">
            
            <a href="jugadores.html" class="btn btn-primary">
                <i class="fas fa-arrow-left mr-2"></i>Menu Jugadores
            </a>
            <div class="text-2xl font-bold" style="color: var(--header-text);">IQSCORE - Posiciones de Liga</div>
        </div>
        <div class="flex items-center space-x-4">
            <button class="theme-switch" id="theme-toggle">
                <i id="theme-icon" class="fas fa-moon"></i>
            </button>
            <button class="md:hidden p-2 rounded theme-switch">
                <i class="fas fa-bars" style="color: var(--header-text);"></i>
            </button>
            <button class="hidden md:block p-2 rounded theme-switch"><i class="fas fa-cog" style="color: var(--header-text);"></i></button>
        </div>
    </header>

     <main class="p-4 md:p-6">
         <div class="flex flex-col md:flex-row justify-start mb-6 gap-4 items-center">
             <div class="flex items-center flex-1 min-w-0">
                 <label for="liga-select" class="mr-2 font-medium whitespace-nowrap">Liga:</label>
                 <select id="liga-select" class="selector flex-1 min-w-0">
                     <option value="">Cargando ligas...</option>
                 </select>
             </div>
             <div class="flex items-center flex-1 min-w-0">
                 <label for="equipo-select" class="mr-2 font-medium whitespace-nowrap">Equipo:</label>
                 <select id="equipo-select" class="selector flex-1 min-w-0" disabled>
                     <option value="">-- Selecciona una liga primero --</option>
                 </select>
             </div>
         </div>

         <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" id="jugadores-container">
             <div id="loading-indicator" class="col-span-full text-center py-12">
                 <div class="flex flex-col items-center justify-center">
                     <i class="fas fa-spinner loading-spinner text-4xl mb-4"></i>
                     <p class="text-xl" style="color: var(--text-secondary);">Selecciona una liga y un equipo...</p>
                 </div>
             </div>
         </div>
     </main>

     <div id="player-details-modal" class="modal">
         <div class="modal-content">
             <span class="modal-close" onclick="closePlayerDetailsModal()">&times;</span>
             <div id="player-details-content">
                 <div class="flex justify-center py-8">
                     <i class="fas fa-spinner loading-spinner text-4xl"></i>
                 </div>
             </div>
             <div id="player-titles-section" class="player-details-section"></div>
             <div id="player-history-section" class="player-details-section"></div>
             <div class="action-buttons mt-6">
                  <button class="btn btn-primary" onclick="closePlayerDetailsModal()">
                      <i class="fas fa-times mr-2"></i> Cerrar
                  </button>
             </div>
         </div>
     </div>

     <footer class="mt-auto">
         &copy; <span id="current-year"></span> IQSCORE. Todos los derechos reservados.
     </footer>

     <script>
         // Configuración de URLs API
         const API_BASE_URL = "https://54.226.15.229:3000/api";
         const LIGAS_API_URL = `${API_BASE_URL}/ligas`;
         const EQUIPOS_POR_LIGA_API_URL = (ligaId) => `${API_BASE_URL}/liga/equipos/${ligaId}`;
         const JUGADORES_POR_EQUIPO_API_URL = (equipoId) => `${API_BASE_URL}/equipo/jugadores/${equipoId}`;
         const JUGADOR_DETALLES_API_URL = (jugadorId) => `${API_BASE_URL}/jugadordetalles/${jugadorId}`;
         const JUGADOR_TITULOS_API_URL = (jugadorId) => `${API_BASE_URL}/jugadordetalles/${jugadorId}/titulos`;
         const JUGADOR_HISTORIAL_API_URL = (jugadorId) => `${API_BASE_URL}/jugadordetalles/${jugadorId}/historial`;
         const ADD_JUGADOR_TITULO_API_URL = (jugadorId) => `${API_BASE_URL}/jugadordetalles/${jugadorId}/titulo`;
         const ADD_JUGADOR_HISTORIAL_API_URL = (jugadorId) => `${API_BASE_URL}/jugadordetalles/${jugadorId}/historial`;
         // --- MODIFICACIÓN --- URLs para borrar por nombre (ajusta puerto/protocolo si es necesario para títulos)
         const DELETE_JUGADOR_TITULO_API_URL = (jugadorId) => `${API_BASE_URL}/jugadordetalles/${jugadorId}/titulo`;
         const DELETE_JUGADOR_HISTORIAL_API_URL = (jugadorId) => `${API_BASE_URL}/jugadordetalles/${jugadorId}/historial`;

         // Elementos del DOM
         const elements = {
             jugadoresContainer: document.getElementById("jugadores-container"),
             ligaSelect: document.getElementById("liga-select"),
             equipoSelect: document.getElementById("equipo-select"),
             loadingIndicator: document.getElementById("loading-indicator"),
             playerDetailsModal: document.getElementById("player-details-modal"),
             playerDetailsContent: document.getElementById("player-details-content"),
             playerTitlesSection: document.getElementById("player-titles-section"),
             playerHistorySection: document.getElementById("player-history-section")
         };

         // Variables de estado
         let state = {
             allLigas: [],
             allEquipos: [],
             currentLigaId: null,
             currentEquipoId: null,
             currentJugadores: [],
             currentTheme: localStorage.getItem('theme') || 'dark',
             currentDetailedPlayerId: null
         };

         // Inicialización
         document.addEventListener("DOMContentLoaded", async () => {
             setupThemeToggle();
             setupModals();
             setupEventListeners();
             await loadLigasForSelect();
             updateCurrentYear();
             showLoadingIndicator("Selecciona una liga para empezar...");
         });

         // Configuración del tema
         function setupThemeToggle() {
             const themeToggle = document.getElementById('theme-toggle');
             const themeIcon = document.getElementById('theme-icon');
             const htmlElement = document.documentElement;
             htmlElement.setAttribute('data-theme', state.currentTheme);
             updateThemeIcon(state.currentTheme);
             themeToggle.addEventListener('click', () => {
                 state.currentTheme = state.currentTheme === 'dark' ? 'light' : 'dark';
                 htmlElement.setAttribute('data-theme', state.currentTheme);
                 localStorage.setItem('theme', state.currentTheme);
                 updateThemeIcon(state.currentTheme);
             });
             function updateThemeIcon(theme) {
                 themeIcon.className = `fas ${theme === 'dark' ? 'fa-moon' : 'fa-sun'}`;
             }
         }

         // Configuración de modales (solo detalles)
         function setupModals() {
             window.addEventListener('click', (event) => {
                 if (event.target === elements.playerDetailsModal) closePlayerDetailsModal();
             });
         }

         // Configuración de event listeners
         function setupEventListeners() {
             elements.ligaSelect.addEventListener('change', async () => {
                 state.currentLigaId = elements.ligaSelect.value;
                 state.currentEquipoId = null;
                 elements.equipoSelect.value = '';
                 elements.jugadoresContainer.innerHTML = '';
                 await loadEquiposForSelect(state.currentLigaId);
             });
             elements.equipoSelect.addEventListener('change', () => {
                 state.currentEquipoId = elements.equipoSelect.value;
                 loadJugadores(state.currentEquipoId);
             });
         }

         // Cargar Ligas
         async function loadLigasForSelect() {
             try {
                 showLoadingIndicator("Cargando ligas...");
                 const response = await fetch(LIGAS_API_URL);
                 if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                 state.allLigas = await response.json();
                 elements.ligaSelect.innerHTML = '<option value="">-- Selecciona Liga --</option>';
                 if (state.allLigas.length > 0) {
                     state.allLigas.forEach(liga => {
                         elements.ligaSelect.add(new Option(liga.nombre, liga.idLiga));
                     });
                 } else {
                     elements.ligaSelect.innerHTML = '<option value="">No hay ligas</option>';
                     showEmptyState(null, null, true);
                 }
             } catch (error) {
                 console.error("Error cargando ligas:", error);
                 elements.ligaSelect.innerHTML = '<option value="">Error al cargar</option>';
                 showErrorState("No se pudieron cargar las ligas.", error.message);
             } finally {
                 hideLoadingIndicator();
             }
         }

         // Cargar Equipos
         async function loadEquiposForSelect(ligaId) {
             elements.equipoSelect.innerHTML = '<option value="">-- Selecciona una liga --</option>';
             elements.equipoSelect.disabled = true;
             if (!ligaId) return;

             try {
                 showLoadingIndicator("Cargando equipos...");
                 elements.equipoSelect.innerHTML = '<option value="">Cargando...</option>';
                 const url = EQUIPOS_POR_LIGA_API_URL(ligaId);
                 const response = await fetch(url);
                 if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                 const equiposData = await response.json();
                 // Asegurarse de mapear correctamente, considerando posibles nombres de propiedad
                 state.allEquipos = equiposData.map(eq => ({ idEquipo: eq.idEquipo || eq.ID_Equipo, nombre: eq.nombre || eq.Nombre }));
                 elements.equipoSelect.innerHTML = '<option value="">-- Selecciona Equipo --</option>';
                 if (state.allEquipos.length > 0) {
                     state.allEquipos.forEach(equipo => {
                         elements.equipoSelect.add(new Option(equipo.nombre, equipo.idEquipo));
                     });
                     elements.equipoSelect.disabled = false;
                     showLoadingIndicator("Selecciona un equipo...");
                 } else {
                     elements.equipoSelect.innerHTML = '<option value="">No hay equipos</option>';
                     showEmptyState(ligaId, null);
                 }
             } catch (error) {
                 console.error("Error cargando equipos:", error);
                 elements.equipoSelect.innerHTML = '<option value="">Error al cargar</option>';
                 showErrorState("No se pudieron cargar los equipos.", error.message);
             } finally {
                 hideLoadingIndicator();
             }
         }

         // Cargar Jugadores
         async function loadJugadores(equipoId) {
             elements.jugadoresContainer.innerHTML = '';
             if (!equipoId) {
                 showLoadingIndicator("Selecciona un equipo...");
                 return;
             }
             try {
                 showLoadingIndicator("Cargando jugadores...");
                 const url = JUGADORES_POR_EQUIPO_API_URL(equipoId);
                 const response = await fetch(url);
                 if (!response.ok) {
                     let errorDetail = `Error ${response.status}: ${response.statusText}`;
                     try { errorDetail = (await response.json()).message || errorDetail; } catch (e) {}
                     throw new Error(errorDetail);
                 }
                 const jugadoresData = await response.json();
                 // Mapeo robusto de propiedades
                 state.currentJugadores = jugadoresData.map(j => ({
                     idJugador: j.ID_Jugador || j.idJugador,
                     nombre: j.Nombre || j.nombre,
                     posicion: j.Posicion || j.posicion,
                     valorMercado: j.Valor_Mercado || j.valor_mercado,
                     logo: j.Foto || j.logo || j.foto // Añadir más posibles nombres si es necesario
                 }));
                 if (state.currentJugadores.length === 0) {
                     showEmptyState(state.currentLigaId, equipoId);
                 } else {
                     renderJugadores(state.currentJugadores);
                 }
             } catch (error) {
                 console.error("Error cargando jugadores:", error);
                 handleLoadError(error, () => loadJugadores(equipoId));
             } finally {
                 hideLoadingIndicator();
             }
         }

         // Renderizar Jugadores
         function renderJugadores(jugadores) {
             elements.jugadoresContainer.innerHTML = '';
             jugadores.forEach(jugador => {
                 const div = document.createElement("div");
                 div.className = "card shadow-lg flex flex-col";
                 const pos = (jugador.posicion || '').toLowerCase();
                 let pClass = '', pBgClass = '';
                 if (pos.includes('delantero') || pos.includes('forward')) { pClass = 'position-fw'; pBgClass = 'position-fw-bg'; }
                 else if (pos.includes('medio') || pos.includes('midfielder')) { pClass = 'position-mf'; pBgClass = 'position-mf-bg'; }
                 else if (pos.includes('defensa') || pos.includes('defender')) { pClass = 'position-df'; pBgClass = 'position-df-bg'; }
                 else if (pos.includes('portero') || pos.includes('goalkeeper')) { pClass = 'position-gk'; pBgClass = 'position-gk-bg'; }
                 const valMercado = jugador.valorMercado ? '€' + new Intl.NumberFormat('de-DE').format(parseFloat(jugador.valorMercado)) : 'N/A';
                 div.innerHTML = `
                     <div class="p-4 flex items-center">
                         <img src="${jugador.logo || 'https://via.placeholder.com/80?text=?'}" alt="${jugador.nombre}" class="player-photo ${pClass}" onerror="this.onerror=null; this.src='https://via.placeholder.com/80?text=X'">
                         <div class="flex-grow">
                             <h3 class="text-lg font-bold mb-1 truncate">${jugador.nombre}</h3>
                             <div class="flex flex-wrap"><span class="position-tag ${pBgClass}">${jugador.posicion || 'N/A'}</span></div>
                             <p class="text-sm mt-1" style="color: var(--text-secondary);"><i class="fas fa-euro-sign mr-1"></i>${valMercado}</p>
                         </div>
                     </div>
                     <div class="mt-auto p-4 pt-0">
                         <div class="action-buttons">
                             <button class="btn btn-primary details-btn w-full" data-id="${jugador.idJugador}"><i class="fas fa-eye mr-1"></i> Ver Detalles</button>
                         </div>
                     </div>`;
                 div.querySelector('.details-btn').addEventListener('click', (e) => showPlayerDetails(e.currentTarget.dataset.id));
                 elements.jugadoresContainer.appendChild(div);
             });
         }

         // Mostrar Detalles Completos del Jugador
         async function showPlayerDetails(jugadorId) {
             state.currentDetailedPlayerId = jugadorId;
             elements.playerDetailsContent.innerHTML = `<div class="flex justify-center py-8"><i class="fas fa-spinner loading-spinner text-4xl"></i></div>`;
             elements.playerTitlesSection.innerHTML = '';
             elements.playerHistorySection.innerHTML = '';
             elements.playerDetailsModal.style.display = 'flex';
             try {
                 const detailsUrl = JUGADOR_DETALLES_API_URL(jugadorId);
                 const detailsResponse = await fetch(detailsUrl);
                 if (!detailsResponse.ok) throw new Error(`HTTP error! status: ${detailsResponse.status} loading details`);
                 const detalles = await detailsResponse.json();
                 renderPlayerDetails(detalles); // Renderiza básicos
                 await loadAndRenderTitles(jugadorId); // Carga y renderiza títulos
                 await loadAndRenderHistory(jugadorId); // Carga y renderiza historial
             } catch (error) {
                 console.error("Error loading player details:", error);
                 elements.playerDetailsContent.innerHTML = `<div class="error-state p-4"><p>Error al cargar detalles: ${error.message}</p></div>`;
             }
         }

         // Renderizar Detalles Básicos del Jugador
         function renderPlayerDetails(detalles) {
             const pos = (detalles.posicion || '').toLowerCase();
             let pClass = '', pBgClass = '';
             if (pos.includes('delantero') || pos.includes('forward')) { pClass = 'position-fw'; pBgClass = 'position-fw-bg'; }
             else if (pos.includes('medio') || pos.includes('midfielder')) { pClass = 'position-mf'; pBgClass = 'position-mf-bg'; }
             else if (pos.includes('defensa') || pos.includes('defender')) { pClass = 'position-df'; pBgClass = 'position-df-bg'; }
             else if (pos.includes('portero') || pos.includes('goalkeeper')) { pClass = 'position-gk'; pBgClass = 'position-gk-bg'; }
             const valMercado = detalles.valor_mercado ? '€' + new Intl.NumberFormat('de-DE').format(parseFloat(detalles.valor_mercado)) : 'N/A';
             const fechaNac = detalles.fecha_nacimiento ? new Date(detalles.fecha_nacimiento).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
             const edad = detalles.edad ? `${detalles.edad} años` : 'N/A';
             const nacLogo = detalles.nacionalidad_logo ? `<img src="${detalles.nacionalidad_logo}" alt="Bandera" class="inline-block h-4 w-auto ml-1">` : '';
             elements.playerDetailsContent.innerHTML = `
                 <div class="player-details-header">
                     <img src="${detalles.logo || 'https://via.placeholder.com/100?text=?'}" alt="${detalles.nombre}" class="player-details-photo ${pClass}" onerror="this.onerror=null; this.src='https://via.placeholder.com/100?text=X'">
                     <div class="player-details-info">
                         <h2 class="player-details-name">${detalles.nombre || '?'}</h2>
                         <p class="player-details-team">${detalles.equipo_actual || 'N/A'} ${detalles.liga ? `(${detalles.liga})` : ''}</p>
                         <div><span class="player-details-position ${pBgClass}">${detalles.posicion || 'N/A'}</span> <span class="text-sm" style="color: var(--text-secondary);">${edad} | ${detalles.nacionalidad || 'N/A'} ${nacLogo}</span></div>
                     </div>
                 </div>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                         <h3 class="player-details-section">Información Básica</h3>
                         <p><strong>Nacimiento:</strong> ${fechaNac}</p>
                         <p><strong>Edad:</strong> ${edad}</p>
                         <p><strong>Nacionalidad:</strong> ${detalles.nacionalidad || 'N/A'} ${nacLogo}</p>
                         <p><strong>Altura:</strong> ${detalles.altura ? detalles.altura + ' m' : 'N/A'}</p>
                         <p><strong>Peso:</strong> ${detalles.peso ? detalles.peso + ' kg' : 'N/A'}</p>
                         <p><strong>Pierna:</strong> ${detalles.pierna_habil || 'N/A'}</p>
                         <p><strong>Pos. Ideal:</strong> ${detalles.posicion_ideal || 'N/A'}</p>
                         <p><strong>Dorsal:</strong> ${detalles.numero_camiseta ?? 'N/A'}</p>
                         <p><strong>Valor:</strong> ${valMercado}</p>
                     </div>
                     <div>
                         <h3 class="player-details-section">Estadísticas (Ejemplo)</h3>
                         <div class="player-details-stats">
                             <div class="player-details-stat"><div class="player-details-stat-value">${detalles.partidos_jugados ?? '0'}</div><div class="player-details-stat-label">Partidos</div></div>
                             <div class="player-details-stat"><div class="player-details-stat-value">${detalles.goles ?? '0'}</div><div class="player-details-stat-label">Goles</div></div>
                             <div class="player-details-stat"><div class="player-details-stat-value">${detalles.asistencias ?? '0'}</div><div class="player-details-stat-label">Asist.</div></div>
                             <div class="player-details-stat"><div class="player-details-stat-value">${detalles.tarjetas_amarillas ?? '0'}</div><div class="player-details-stat-label">Amarillas</div></div>
                             <div class="player-details-stat"><div class="player-details-stat-value">${detalles.tarjetas_rojas ?? '0'}</div><div class="player-details-stat-label">Rojas</div></div>
                             <div class="player-details-stat"><div class="player-details-stat-value">${detalles.pases_completados ?? '0'}%</div><div class="player-details-stat-label">Pases %</div></div>
                         </div>
                     </div>
                 </div>
                 <div class="player-details-section"><h3>Habilidades</h3><p>${detalles.habilidades || 'N/A'}</p></div>
                 <div class="player-details-section"><h3>Características</h3><p>${detalles.caracteristicas || 'N/A'}</p></div>
                 <div class="player-details-section"><h3>Atributos</h3><p>${detalles.atributos || 'N/A'}</p></div>`;
         }

         // Cargar y Renderizar Títulos
         async function loadAndRenderTitles(jugadorId) {
             elements.playerTitlesSection.innerHTML = `<h3>Títulos <i class="fas fa-spinner loading-spinner text-sm"></i></h3>`;
             try {
                 const url = JUGADOR_TITULOS_API_URL(jugadorId);
                 const response = await fetch(url);
                 if (!response.ok) throw new Error(`HTTP error! status: ${response.status} loading titles`);
                 const titulos = await response.json();
                 let html = `<h3>Títulos (${titulos.length}) <button class="btn btn-success btn-sm ml-2" onclick="showAddTitleForm()"><i class="fas fa-plus"></i> Añadir</button></h3>`;
                 if (titulos.length > 0) {
                     html += '<ul class="list-disc pl-5 mt-2 space-y-1">';
                     titulos.forEach(t => {
                         // Asegúrate de que tu API devuelva 'nombre_titulo' y 'año'
                         const nombreTitulo = t.nombre_titulo || 'Título Desconocido';
                         const año = t.año || '????';
                         // --- MODIFICACIÓN --- Llamada a deleteTitle con nombreTitulo
                         html += `<li class="flex justify-between items-center">
                                     <span><i class="fas fa-trophy mr-2 text-yellow-400"></i> ${nombreTitulo} (${año})</span>
                                     <button class="btn btn-danger btn-sm" onclick="deleteTitle('${jugadorId}', '${nombreTitulo.replace(/'/g, "\\'")}')"><i class="fas fa-trash-alt"></i></button>
                                  </li>`;
                     });
                     html += '</ul>';
                 } else {
                     html += '<p class="text-sm text-gray-500 mt-2">No hay títulos registrados.</p>';
                 }
                 html += '<div id="add-title-form-container" class="mt-4 hidden"></div>';
                 elements.playerTitlesSection.innerHTML = html;
             } catch (error) {
                 console.error("Error loading titles:", error);
                 elements.playerTitlesSection.innerHTML = `<h3>Títulos</h3><p class="text-red-500 text-sm">Error: ${error.message}</p>`;
             }
         }

         // Cargar y Renderizar Historial
         async function loadAndRenderHistory(jugadorId) {
             elements.playerHistorySection.innerHTML = `<h3>Historial <i class="fas fa-spinner loading-spinner text-sm"></i></h3>`;
             try {
                 const url = JUGADOR_HISTORIAL_API_URL(jugadorId);
                 const response = await fetch(url);
                 if (!response.ok) throw new Error(`HTTP error! status: ${response.status} loading history`);
                 const historial = await response.json();
                 let html = `<h3>Historial (${historial.length}) <button class="btn btn-success btn-sm ml-2" onclick="showAddHistoryForm()"><i class="fas fa-plus"></i> Añadir</button></h3>`;
                 if (historial.length > 0) {
                     html += '<ul class="list-none mt-2 space-y-2">';
                     historial.forEach(h => {
                         // Asegúrate de que tu API devuelva 'nombre_equipo', 'año_inicio', 'año_fin', 'foto_equipo'
                         const nombreEquipo = h.nombre_equipo || 'Equipo Desconocido';
                         const añoInicio = h.año_inicio || '????';
                         const añoFin = h.año_fin || 'Pres.';
                         const foto = h.foto_equipo ? `<img src="${h.foto_equipo}" alt="${nombreEquipo}" class="w-8 h-8 object-contain inline-block mr-2 rounded" onerror="this.style.display='none'">` : '<i class="fas fa-shield-alt mr-2 text-gray-500"></i>';
                         // --- MODIFICACIÓN --- Llamada a deleteHistory con nombreEquipo
                         html += `
                             <li class="flex justify-between items-center p-2 bg-[var(--input-bg)] rounded">
                                 <div>${foto}<span class="font-semibold">${nombreEquipo}</span> <span class="text-sm text-gray-400 ml-2">(${añoInicio} - ${añoFin})</span></div>
                                 <button class="btn btn-danger btn-sm" onclick="deleteHistory('${jugadorId}', '${nombreEquipo.replace(/'/g, "\\'")}')"><i class="fas fa-trash-alt"></i></button>
                             </li>`;
                     });
                     html += '</ul>';
                 } else {
                     html += '<p class="text-sm text-gray-500 mt-2">No hay historial registrado.</p>';
                 }
                 html += '<div id="add-history-form-container" class="mt-4 hidden"></div>';
                 elements.playerHistorySection.innerHTML = html;
             } catch (error) {
                 console.error("Error loading history:", error);
                 elements.playerHistorySection.innerHTML = `<h3>Historial</h3><p class="text-red-500 text-sm">Error: ${error.message}</p>`;
             }
         }

         // Formularios Add Título/Historial y sus handlers
         function showAddTitleForm() {
             const cont = document.getElementById('add-title-form-container');
             cont.innerHTML = `<form id="add-title-form" class="p-3 border rounded bg-[var(--input-bg)]"><h4 class="font-semibold mb-2">Añadir Título</h4><div class="form-group"><label for="ntn">Nombre:</label><input type="text" id="ntn" required></div><div class="form-group"><label for="nty">Año:</label><input type="number" id="nty" required min="1900" max="${new Date().getFullYear()}"></div><div class="action-buttons"><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Guardar</button><button type="button" class="btn btn-secondary" onclick="hideAddTitleForm()"><i class="fas fa-times"></i> Cancelar</button></div></form>`;
             cont.classList.remove('hidden');
             cont.querySelector('form').addEventListener('submit', handleAddTitleSubmit);
         }
         function hideAddTitleForm() { document.getElementById('add-title-form-container').classList.add('hidden'); }

         function showAddHistoryForm() {
             const cont = document.getElementById('add-history-form-container');
             cont.innerHTML = `<form id="add-history-form" class="p-3 border rounded bg-[var(--input-bg)]"><h4 class="font-semibold mb-2">Añadir Equipo</h4><div class="form-group"><label for="nht">Equipo:</label><input type="text" id="nht" required></div><div class="grid grid-cols-2 gap-4"><div class="form-group"><label for="nhs">Año Inicio:</label><input type="number" id="nhs" required min="1900" max="${new Date().getFullYear()}"></div><div class="form-group"><label for="nhe">Año Fin:</label><input type="number" id="nhe" min="1900" max="${new Date().getFullYear()}"></div></div><div class="form-group"><label for="nhp">URL Foto:</label><input type="url" id="nhp"></div><div class="action-buttons"><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Guardar</button><button type="button" class="btn btn-secondary" onclick="hideAddHistoryForm()"><i class="fas fa-times"></i> Cancelar</button></div></form>`;
             cont.classList.remove('hidden');
             cont.querySelector('form').addEventListener('submit', handleAddHistorySubmit);
         }
         function hideAddHistoryForm() { document.getElementById('add-history-form-container').classList.add('hidden'); }

         async function handleAddTitleSubmit(e) {
             e.preventDefault();
             const jId = state.currentDetailedPlayerId; if (!jId) return;
             const data = { nombre_titulo: document.getElementById('ntn').value, año: parseInt(document.getElementById('nty').value) };
             try {
                 const r = await fetch(ADD_JUGADOR_TITULO_API_URL(jId), { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                 if (!r.ok) { const ed = await r.json().catch(()=>{}); throw new Error(ed?.message || `Error ${r.status}`); }
                 showNotification('Título agregado', 'success');
                 hideAddTitleForm(); await loadAndRenderTitles(jId);
             } catch (err) { showNotification(`Error al agregar título: ${err.message}`, 'error'); }
         }

         async function handleAddHistorySubmit(e) {
             e.preventDefault();
             const jId = state.currentDetailedPlayerId; if (!jId) return;
             const data = {
                 nombre_equipo: document.getElementById('nht').value,
                 año_inicio: parseInt(document.getElementById('nhs').value),
                 año_fin: document.getElementById('nhe').value ? parseInt(document.getElementById('nhe').value) : null,
                 foto_equipo: document.getElementById('nhp').value || null
             };
             if (data.año_fin && data.año_fin < data.año_inicio) { showNotification('Año fin no puede ser menor que Año inicio', 'error'); return; }
             try {
                 const r = await fetch(ADD_JUGADOR_HISTORIAL_API_URL(jId), { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) });
                 if (!r.ok) { const ed = await r.json().catch(()=>{}); throw new Error(ed?.message || `Error ${r.status}`); }
                 showNotification('Historial agregado', 'success');
                 hideAddHistoryForm(); await loadAndRenderHistory(jId);
             } catch (err) { showNotification(`Error al agregar historial: ${err.message}`, 'error'); }
         }

         // --- MODIFICACIÓN --- Borrar Título por nombre
         async function deleteTitle(jugadorId, nombreTitulo) {
             if (!confirm(`¿Eliminar título "${nombreTitulo}"?`)) return;
             try {
                 const url = DELETE_JUGADOR_TITULO_API_URL(jugadorId);
                 const r = await fetch(url, {
                     method: 'DELETE', // O el método correcto que espere tu API
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({ nombreTitulo: nombreTitulo })
                 });
                 if (!r.ok) {
                     const ed = await r.json().catch(()=>{ return { message: `Error ${r.status}` }; });
                     throw new Error(ed.message || `Error ${r.status}`);
                 }
                 showNotification('Título eliminado', 'success');
                 await loadAndRenderTitles(jugadorId); // Recargar títulos
             } catch (err) {
                 showNotification(`Error al eliminar título: ${err.message}`, 'error');
             }
         }

         // --- MODIFICACIÓN --- Borrar Historial por nombre de equipo
         async function deleteHistory(jugadorId, nombreEquipo) {
             if (!confirm(`¿Eliminar historial del equipo "${nombreEquipo}"?`)) return;
             try {
                 const url = DELETE_JUGADOR_HISTORIAL_API_URL(jugadorId);
                 const r = await fetch(url, {
                     method: 'DELETE', // O el método correcto que espere tu API
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({ nombreEquipo: nombreEquipo })
                 });
                  if (!r.ok) {
                     const ed = await r.json().catch(()=>{ return { message: `Error ${r.status}` }; });
                     throw new Error(ed.message || `Error ${r.status}`);
                 }
                 showNotification('Historial eliminado', 'success');
                 await loadAndRenderHistory(jugadorId); // Recargar historial
             } catch (err) {
                 showNotification(`Error al eliminar historial: ${err.message}`, 'error');
             }
         }

         // Cerrar Modal Detalles
         function closePlayerDetailsModal() {
             elements.playerDetailsModal.style.display = 'none';
             state.currentDetailedPlayerId = null;
         }

         // Indicador Carga, Estado Vacío, Estado Error, Notificación, Año Footer
         function showLoadingIndicator(message = "Cargando...") {
             elements.loadingIndicator.innerHTML = `<div class="flex flex-col items-center justify-center py-8"><i class="fas fa-spinner loading-spinner text-4xl mb-4"></i><p class="text-xl" style="color: var(--text-secondary);">${message}</p></div>`;
             elements.loadingIndicator.style.display = 'block';
             elements.jugadoresContainer.innerHTML = ''; // Limpiar jugadores mientras carga
         }
         function hideLoadingIndicator() {
              elements.loadingIndicator.style.display = 'none';
         }
         function showEmptyState(ligaId, equipoId, noLigas = false) {
             hideLoadingIndicator();
             let msg = noLigas ? 'No se encontraron ligas disponibles.' : !ligaId ? 'Por favor, selecciona una liga para ver los equipos.' : !equipoId ? 'Por favor, selecciona un equipo para ver los jugadores.' : 'No se encontraron jugadores para este equipo.';
             elements.jugadoresContainer.innerHTML = `<div class="col-span-full empty-state py-12"><i class="fas fa-users-slash empty-state-icon"></i><p class="text-xl font-medium mb-4">${msg}</p></div>`;
         }
        function showErrorState(errorMessage, errorDetails, retryCallback) {
            hideLoadingIndicator();
            console.error(errorMessage, errorDetails);
            // Usa jugadoresContainer para mostrar el error si loadingIndicator ya no es visible
            const targetElement = (elements.loadingIndicator.style.display !== 'none') ? elements.loadingIndicator : elements.jugadoresContainer;
            targetElement.innerHTML = `<div class="col-span-full error-state py-12"><i class="fas fa-exclamation-triangle text-4xl mb-4"></i><p class="text-xl font-medium mb-2">${errorMessage}</p><p class="text-sm mb-4">${errorDetails || 'Ocurrió un error inesperado.'}</p>${retryCallback ? `<button class="btn btn-primary" onclick="(${retryCallback.toString()})()"><i class="fas fa-sync-alt mr-2"></i>Reintentar</button>` : ''}</div>`;
            if (targetElement === elements.jugadoresContainer) targetElement.classList.add('col-span-full'); // Asegura que ocupe todo el ancho si está en el contenedor de jugadores
        }

         function handleLoadError(error, retryCallback) {
             let msg = "Error cargando datos.", detail = error.message || "Desconocido.";
             if (error.name === 'AbortError') { msg = "Timeout."; detail = "Verifica conexión/servidor."; }
             else if (error.message.includes("fetch") || error.message.includes("Network")) { msg = "Fallo de conexión."; detail = `Verifica URL (${API_BASE_URL}).`; }
             else if (error.message.includes("404")) { msg = "No encontrado (404)."; detail = `URL incorrecta?`; }
             else if (error.message.includes("500")) { msg = "Error Servidor (500)."; detail = "Problema en backend."; }
             showErrorState(msg, detail, retryCallback);
         }
         function showNotification(message, type = 'info') {
             const div = document.createElement('div');
             // Asegúrate que las clases de color de fondo existan en tu CSS o Tailwind
             let bgColorClass = 'bg-blue-500'; // default info
             if (type === 'success') bgColorClass = 'bg-green-500';
             else if (type === 'error') bgColorClass = 'bg-red-500';

             div.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white z-50 ${bgColorClass}`;
             div.innerHTML = `<div class="flex items-center"><i class="fas ${type==='success'?'fa-check-circle':type==='error'?'fa-exclamation-circle':'fa-info-circle'} mr-2"></i><span>${message}</span></div>`;
             document.body.appendChild(div);
             setTimeout(() => { div.style.transition = 'opacity 0.5s ease'; div.style.opacity = '0'; setTimeout(() => div.remove(), 500); }, 3000);
         }
         function updateCurrentYear() { document.getElementById('current-year').textContent = new Date().getFullYear(); }

     </script>
 </body>
 </html>