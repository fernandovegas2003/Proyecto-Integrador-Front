<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Títulos de Equipos - IQSCORE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <style>
        /* Estilos generales (copy from original script.txt) */
        [data-theme="dark"] {
            --bg-color: #000000; /* [cite: 1] */
            --header-bg: linear-gradient(145deg, #1E1E1E, #000000); /* [cite: 2] */
            --card-bg: linear-gradient(145deg, #1E1E1E, #2B2B2B); /* [cite: 2] */
            --text-color: #ffffff; /* [cite: 2] */
            --text-secondary: #a0aec0; /* [cite: 2] */
            --input-bg: #1a202c; /* [cite: 2] */
            --card-shadow: 0 10px 20px rgba(160, 32, 240, 0.3); /* [cite: 3] */
            --header-text: #ffffff; /* [cite: 3] */
            --error-bg: #2d0707; /* [cite: 3] */
            --error-text: #ff6b6b; /* [cite: 3] */
            --modal-bg: rgba(0, 0, 0, 0.8);
            --modal-content-bg: #1E1E1E; /* Slightly different from card for emphasis */
        }

        [data-theme="light"] {
            --bg-color: #f7fafc; /* [cite: 4] */
            --header-bg: #3357E9; /* [cite: 5] */
            --card-bg: linear-gradient(145deg, #ffffff, #f7fafc); /* [cite: 5] */
            --text-color: #1a202c; /* [cite: 5] */
            --text-secondary: #4a5568; /* [cite: 5] */
            --input-bg: #edf2f7; /* [cite: 5] */
            --card-shadow: 0 10px 20px rgba(37, 99, 235, 0.2); /* [cite: 5] */
            --header-text: #ffffff; /* [cite: 6] */
            --error-bg: #fee2e2; /* [cite: 6] */
            --error-text: #b91c1c; /* [cite: 6] */
            --modal-bg: rgba(0, 0, 0, 0.5);
            --modal-content-bg: #ffffff;
        }

        body {
            background-color: var(--bg-color); /* [cite: 6] */
            color: var(--text-color); /* [cite: 7] */
            transition: background-color 0.3s ease, color 0.3s ease; /* [cite: 7] */
            margin: 0; /* [cite: 7] */
            padding: 0; /* [cite: 7] */
            min-height: 100vh; /* [cite: 7] */
            display: flex; /* [cite: 7] */
            flex-direction: column; /* [cite: 7] */
        }

        .header-bg { background: var(--header-bg); } /* [cite: 8] */
        main { flex: 1; } /* [cite: 9] */

        .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease; /* [cite: 10] */
            background: var(--card-bg); /* [cite: 11] */
            color: var(--text-color); /* [cite: 11] */
            padding: 1.5rem; /* [cite: 11] */
            border-radius: 0.5rem; /* [cite: 11] */
            display: flex; /* [cite: 11] */
            flex-direction: column; /* [cite: 11] */
            justify-content: space-between; /* [cite: 11] */
            height: 100%; /* [cite: 11] */
        }
        .card:hover {
            transform: translateY(-5px); /* Adjusted hover effect */
            box-shadow: var(--card-shadow); /* [cite: 13] */
        }

        .theme-switch {
            transition: all 0.3s ease; /* [cite: 13] */
            padding: 0.5rem; /* [cite: 14] */
            border-radius: 0.375rem; /* [cite: 14] */
            background-color: rgba(255, 255, 255, 0.2); /* [cite: 14] */
            border: none; /* [cite: 14] */
            cursor: pointer; /* [cite: 14] */
        }
        .theme-switch:hover { background-color: rgba(255, 255, 255, 0.3); } /* [cite: 15] */
        .theme-switch i { color: var(--header-text); } /* [cite: 16] */

        footer {
            background: var(--header-bg); /* [cite: 17] */
            color: var(--header-text); /* [cite: 18] */
            text-align: center; /* [cite: 18] */
            padding: 1rem; /* [cite: 18] */
            margin-top: auto; /* [cite: 18] */
            font-size: 0.875rem; /* [cite: 18] */
        }

        .liga-selector {
            background-color: var(--input-bg); /* [cite: 19] */
            color: var(--text-color); /* [cite: 20] */
            border: 1px solid color-mix(in srgb, var(--input-bg) 80%, var(--text-color)); /* [cite: 20] */
            padding: 0.5rem 1rem; /* [cite: 20] */
            border-radius: 0.375rem; /* [cite: 20] */
            margin-right: 1rem; /* [cite: 20] */
        }

        .team-logo {
            width: 60px; /* [cite: 21] */
            height: 60px; /* [cite: 22] */
            object-fit: contain; /* [cite: 22] */
            margin-right: 1rem; /* [cite: 22] */
            flex-shrink: 0; /* [cite: 22] */
        }

        .stadium-logo {
            width: 100%; /* [cite: 22] */
            height: 150px; /* [cite: 23] */
            object-fit: cover; /* [cite: 23] */
            border-radius: 0.25rem; /* [cite: 23] */
            margin-top: 1rem; /* [cite: 23] */
        }

        .error-state {
            background-color: var(--error-bg); /* [cite: 23] */
            color: var(--error-text); /* [cite: 24] */
            padding: 2rem; /* [cite: 24] */
            border-radius: 0.5rem; /* [cite: 24] */
            text-align: center; /* [cite: 24] */
        }

        .empty-state {
            padding: 2rem; /* [cite: 24] */
            text-align: center; /* [cite: 25] */
            color: var(--text-secondary); /* [cite: 25] */
        }

        .loading-spinner { animation: spin 1s linear infinite; } /* [cite: 25] */
        @keyframes spin {
            0% { transform: rotate(0deg); } /* [cite: 26] */
            100% { transform: rotate(360deg); } /* [cite: 27] */
        }

        /* Modal styles */
        .modal {
            display: none; /* [cite: 28] */
            position: fixed; /* [cite: 29] */
            top: 0; /* [cite: 29] */
            left: 0; /* [cite: 29] */
            width: 100%; /* [cite: 29] */
            height: 100%; /* [cite: 29] */
            background-color: var(--modal-bg);
            z-index: 1000; /* [cite: 29] */
            justify-content: center; /* [cite: 29] */
            align-items: center; /* [cite: 30] */
            overflow-y: auto; /* Allow scrolling if modal is too tall */
            padding: 2rem; /* Padding for smaller screens */
        }

        .modal-content {
            background: var(--modal-content-bg);
            padding: 2rem; /* [cite: 31] */
            border-radius: 0.5rem; /* [cite: 31] */
            width: 90%; /* [cite: 31] */
            max-width: 600px; /* Adjusted max-width */
            max-height: 90vh; /* [cite: 31] */
            overflow-y: auto; /* [cite: 31] */
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .modal-close {
            float: right; /* [cite: 32] */
            cursor: pointer; /* [cite: 33] */
            font-size: 1.5rem; /* [cite: 33] */
            line-height: 1;
            color: var(--text-secondary);
            transition: color 0.2s;
        }
         .modal-close:hover {
             color: var(--text-color);
         }

        .form-group { margin-bottom: 1rem; } /* [cite: 34] */
        .form-group label {
            display: block; /* [cite: 35] */
            margin-bottom: 0.5rem; /* [cite: 35] */
            font-weight: 600; /* [cite: 35] */
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; /* [cite: 35] */
            padding: 0.75rem; /* [cite: 36] */
            border-radius: 0.25rem; /* [cite: 36] */
            border: 1px solid var(--text-secondary); /* [cite: 36] */
            background-color: var(--input-bg); /* [cite: 36] */
            color: var(--text-color); /* [cite: 36] */
            box-sizing: border-box; /* Added for better sizing */
        }

        .btn {
            padding: 0.75rem 1.25rem; /* Adjusted padding */
            border-radius: 0.25rem; /* [cite: 38] */
            cursor: pointer; /* [cite: 38] */
            font-weight: 600; /* [cite: 38] */
            transition: all 0.2s; /* [cite: 38] */
            border: none; /* [cite: 38] */
            text-align: center;
            display: inline-flex; /* Align icon and text */
            align-items: center;
            justify-content: center;
        }
         .btn i { margin-right: 0.5rem; }

        .btn-primary { background-color: #4C4CFF; color: white; } /* [cite: 39, 40] */
        .btn-primary:hover { background-color: #3a3aff; } /* [cite: 40] */
        .btn-danger { background-color: #ff4c4c; color: white; } /* [cite: 41, 42] */
        .btn-danger:hover { background-color: #ff3333; } /* [cite: 42] */
        .btn-success { background-color: #4CAF50; color: white; } /* [cite: 43, 44] */
        .btn-success:hover { background-color: #3e8e41; } /* [cite: 44] */
        .btn-info { background-color: #2196F3; color: white; }
        .btn-info:hover { background-color: #0b7dda; }


        .action-buttons {
            display: flex; /* [cite: 45] */
            gap: 0.75rem; /* [cite: 46] */
            margin-top: 1.5rem; /* [cite: 46] */
        }
        .action-buttons .btn { flex: 1; } /* [cite: 46] */


        /* Titulos Modal Specific Styles */
        #titulos-list {
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            max-height: 250px; /* Limit height and make scrollable */
            overflow-y: auto;
            border: 1px solid var(--text-secondary);
            border-radius: 0.25rem;
            padding: 1rem;
        }
        .titulo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid color-mix(in srgb, var(--input-bg) 80%, var(--text-color));
        }
        .titulo-item:last-child {
            border-bottom: none;
        }
        .titulo-details {
            flex-grow: 1;
            margin-right: 1rem;
        }
        .titulo-name { font-weight: 600; }
        .titulo-year { color: var(--text-secondary); font-size: 0.9em; }
        .titulo-delete-btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.8rem; /* Smaller delete button */
        }
         #add-titulo-form { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--text-secondary);}
         #add-titulo-form h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem;}

        /* Ensure consistency */
         input[type="number"] { /* Fix potential spinner issues */
             -moz-appearance: textfield;
         }
         input[type="number"]::-webkit-outer-spin-button,
         input[type="number"]::-webkit-inner-spin-button {
             -webkit-appearance: none;
             margin: 0;
         }

    </style>
</head>
<body>
    <header class="flex justify-between items-center p-4 header-bg shadow-lg">
        <div class="flex items-center space-x-4">
            
            <a href="equipos.html" class="btn btn-primary">
                <i class="fas fa-arrow-left mr-2"></i>Menu Equipos
            </a>
            <div class="text-2xl font-bold" style="color: var(--header-text);">IQSCORE - Posiciones de Liga</div>
        </div>
        <div class="flex items-center space-x-4">
            <button class="theme-switch" id="theme-toggle">
                <i id="theme-icon" class="fas fa-moon"></i>
            </button>
            <button class="md:hidden p-2 rounded theme-switch">
                <i class="fas fa-bars" style="color: var(--header-text);"></i>
            </button>
            <button class="hidden md:block p-2 rounded theme-switch"><i class="fas fa-cog" style="color: var(--header-text);"></i></button>
        </div>
    </header>

    <main class="p-6">
         <div class="flex justify-start mb-6">
            <div class="flex items-center">
                 <label for="liga-select" class="mr-2 font-medium">Ver equipos de la liga:</label>
                 <select id="liga-select" class="liga-selector">
                     <option value="">Cargando ligas...</option>
                 </select>
             </div>
         </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="equipos-container">
            <div id="loading-indicator" class="col-span-full text-center py-12">
                <div class="flex flex-col items-center justify-center">
                    <i class="fas fa-spinner loading-spinner text-4xl mb-4" style="color: var(--text-secondary);"></i> <p class="text-xl" style="color: var(--text-secondary);">Selecciona una liga para ver los equipos...</p> </div>
            </div>
        </div>
    </main>

    <div id="titulos-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="titulos-modal-close">&times;</span>
            <h2 class="text-xl font-bold mb-2" id="titulos-modal-title">Gestionar Títulos</h2>
             <p class="text-sm mb-4" id="titulos-modal-team-name" style="color: var(--text-secondary);"></p>

            <div id="titulos-loading" class="text-center py-4" style="display: none;">
                <i class="fas fa-spinner loading-spinner text-2xl" style="color: var(--text-secondary);"></i>
                <p style="color: var(--text-secondary);">Cargando títulos...</p>
            </div>

             <div id="titulos-error" class="error-state my-4" style="display: none; padding: 1rem;">
                 Error al cargar títulos.
             </div>

            <div id="titulos-list">
                <p class="empty-state" style="padding: 1rem 0;">No hay títulos para mostrar.</p>
            </div>

            <form id="add-titulo-form">
                 <h3>Agregar Nuevo Título</h3>
                 <input type="hidden" id="titulo-equipo-id">
                <div class="form-group">
                    <label for="titulo-nombre">Nombre del Título:</label>
                    <input type="text" id="titulo-nombre" required>
                </div>
                <div class="form-group">
                    <label for="titulo-año">Año:</label>
                    <input type="number" id="titulo-año" required min="1800" max="2100"> </div>
                <button type="submit" class="btn btn-success w-full">
                    <i class="fas fa-plus"></i>Agregar Título
                </button>
            </form>
             <div id="add-titulo-error" class="error-state mt-3" style="display: none; padding: 0.5rem; font-size: 0.9em;"></div>

        </div>
    </div>

    <footer class="mt-auto">
        &copy; <span id="current-year"></span> IQSCORE. Todos los derechos reservados. </footer>

    <script>
        // Configuración de URLs API
        const API_BASE_URL = "https://54.226.15.229:3000/api"; /* [cite: 75] */
        const LIGAS_API_URL = `${API_BASE_URL}/ligas`; /* [cite: 76] */
        const EQUIPOS_API_URL = `${API_BASE_URL}/equipo`; /* [cite: 76] */
        // Use 3001 consistently as per most examples in script.txt
        const TITULOS_API_URL_BASE = `${API_BASE_URL}/equipo/titulo`; // Base URL for titles [cite: 189, 192]
        // Note: The user mentioned different ports (3000/3001) for DELETE. Using 3001 for consistency.
        const TITULOS_DELETE_API_URL_BASE = `${API_BASE_URL}/equipo/titulo`; // Assuming port 3001 [cite: 192]

        // --- DOM Elements ---
        const equiposContainer = document.getElementById("equipos-container"); /* [cite: 76] */
        const ligaSelect = document.getElementById("liga-select"); /* [cite: 77] */
        const loadingIndicator = document.getElementById("loading-indicator"); /* [cite: 77] */
        const titulosModal = document.getElementById("titulos-modal");
        const titulosModalClose = document.getElementById("titulos-modal-close");
        const titulosModalTitle = document.getElementById("titulos-modal-title");
        const titulosModalTeamName = document.getElementById("titulos-modal-team-name");
        const titulosListContainer = document.getElementById("titulos-list");
        const addTituloForm = document.getElementById("add-titulo-form");
        const tituloEquipoIdInput = document.getElementById("titulo-equipo-id");
        const tituloNombreInput = document.getElementById("titulo-nombre");
        const tituloAñoInput = document.getElementById("titulo-año");
        const titulosLoading = document.getElementById("titulos-loading");
        const titulosError = document.getElementById("titulos-error");
        const addTituloError = document.getElementById("add-titulo-error");

        // --- State Variables ---
        let allLigas = []; /* [cite: 79] */
        let currentLigaId = null; /* [cite: 79] */
        let currentEquipos = []; // Store currently displayed teams
        let currentTeamForTitles = null; // Store the team object whose titles are being managed

        // --- Theme Toggle ---
        function setupThemeToggle() {
             const themeToggle = document.getElementById('theme-toggle'); /* [cite: 80] */
             const themeIcon = document.getElementById('theme-icon'); /* [cite: 81] */
             const htmlElement = document.documentElement; /* [cite: 81] */

             const savedTheme = localStorage.getItem('theme') || 'dark'; /* [cite: 81] */
             htmlElement.setAttribute('data-theme', savedTheme); /* [cite: 81] */
             updateThemeIcon(savedTheme); /* [cite: 81] */

             themeToggle.addEventListener('click', () => { /* [cite: 82] */
                 const currentTheme = htmlElement.getAttribute('data-theme'); /* [cite: 82] */
                 const newTheme = currentTheme === 'dark' ? 'light' : 'dark'; /* [cite: 82] */
                 htmlElement.setAttribute('data-theme', newTheme); /* [cite: 82] */
                 localStorage.setItem('theme', newTheme); /* [cite: 82] */
                 updateThemeIcon(newTheme); /* [cite: 82] */
             }); /* [cite: 83] */

             function updateThemeIcon(theme) { /* [cite: 84] */
                 if (theme === 'dark') {
                     themeIcon.classList.remove('fa-sun'); /* [cite: 84] */
                     themeIcon.classList.add('fa-moon'); /* [cite: 85] */
                 } else {
                     themeIcon.classList.remove('fa-moon'); /* [cite: 85] */
                     themeIcon.classList.add('fa-sun'); /* [cite: 86] */
                 }
             }
        }

        // --- Modal Setup ---
        function setupModals() {
            titulosModalClose.addEventListener('click', closeTitulosModal); /* [cite: 87] */
            // Close modal clicking outside
            window.addEventListener('click', (event) => { /* [cite: 88] */
                if (event.target === titulosModal) { /* [cite: 88] */
                    closeTitulosModal(); /* [cite: 89] */
                }
            }); /* [cite: 89] */
        }

        function openTitulosModal(equipo) {
            currentTeamForTitles = equipo;
            titulosModalTitle.textContent = `Gestionar Títulos`;
            titulosModalTeamName.textContent = `Equipo: ${equipo.nombre}`;
            tituloEquipoIdInput.value = equipo.idEquipo; // Set hidden input for the form
            addTituloForm.reset(); // Clear form
            addTituloError.style.display = 'none'; // Hide previous errors
            titulosError.style.display = 'none';
            titulosListContainer.innerHTML = '<p class="empty-state" style="padding: 1rem 0;">Cargando...</p>'; // Initial state

            titulosModal.style.display = 'flex';
            loadTitulosForTeam(equipo.idEquipo);
        }

        function closeTitulosModal() {
            titulosModal.style.display = 'none';
            currentTeamForTitles = null; // Clear the selected team
        }

        // --- API Fetching & Rendering ---

        async function fetchWithTimeout(url, options = {}, timeout = 8000) {
             const controller = new AbortController(); /* [cite: 131] */
             const id = setTimeout(() => controller.abort(), timeout); /* [cite: 131] */
             options.signal = controller.signal; /* [cite: 132] */

             try {
                 const response = await fetch(url, options); /* [cite: 132] */
                 clearTimeout(id); /* [cite: 132] */
                 return response;
             } catch (error) {
                 clearTimeout(id); /* [cite: 132] */
                 throw error; // Re-throw the error (likely AbortError or network error)
             }
        }

        async function loadLigasForSelect() {
            try {
                 const response = await fetchWithTimeout(LIGAS_API_URL); /* [cite: 100] */
                 if (!response.ok) { /* [cite: 101] */
                     throw new Error(`HTTP error! status: ${response.status} ${response.statusText}`); /* [cite: 101] */
                 }
                 allLigas = await response.json(); /* [cite: 102] */
                 ligaSelect.innerHTML = '<option value="">-- Selecciona una Liga --</option>'; /* [cite: 103] */
                 if (allLigas.length > 0) { /* [cite: 105] */
                     allLigas.forEach(liga => { /* [cite: 105] */
                         const option = document.createElement('option'); /* [cite: 105] */
                         option.value = liga.idLiga; /* [cite: 105] */
                         option.textContent = liga.nombre; /* [cite: 106] */
                         ligaSelect.appendChild(option); /* [cite: 106] */
                     }); /* [cite: 106] */
                 } else {
                     ligaSelect.innerHTML = '<option value="">No hay ligas disponibles</option>'; /* [cite: 107] */
                     showEmptyState(null, true); /* [cite: 108] */
                 }
                 return allLigas; /* [cite: 108] */
             } catch (error) { /* [cite: 109] */
                 console.error("Error fetching ligas:", error); /* [cite: 109] */
                 ligaSelect.innerHTML = '<option value="">Error al cargar ligas</option>'; /* [cite: 110] */
                 showErrorState("No se pudieron cargar las ligas. Verifica la conexión o la URL de la API."); /* [cite: 110] */
                 return []; /* [cite: 111] */
             }
        }

        // Function to render Liga Info (slightly modified from original)
        function renderLigaInfo(liga) {
             const existingInfoCard = document.getElementById('liga-info-card');
             if(existingInfoCard) existingInfoCard.remove(); // Remove previous card if exists

            const ligaInfoHTML = `
                <div id="liga-info-card" class="liga-info-card" style="background: var(--card-bg); color: var(--text-color); padding: 1.5rem; border-radius: 0.5rem; box-shadow: var(--card-shadow); grid-column: 1 / -1; margin-bottom: 2rem; display: flex; flex-direction: column; align-items: center; text-align: center;">
                    <div class="liga-info-header" style="display: flex; align-items: center; margin-bottom: 1.5rem; width: 100%;">
                         <img src="${liga.imagen_logo || 'https://via.placeholder.com/80?text=N/A'}"
                             alt="${liga.nombre} Logo"
                             class="liga-logo" style="width: 80px; height: 80px; object-fit: contain; margin-right: 1.5rem;"
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/80?text=Error'">
                        <div class="text-left flex-grow">
                            <h2 class="text-2xl font-bold">${liga.nombre}</h2>
                            <p class="text-lg" style="color: var(--text-secondary);">${liga.pais || 'N/A'} - ${liga.nivel || 'N/A'}</p>
                        </div>
                    </div>
                    <div class="liga-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; width: 100%; margin-top: 1rem;">
                        <div class="liga-detail-item" style="background: rgba(255, 255, 255, 0.05); padding: 0.75rem; border-radius: 0.25rem;">
                            <strong>Temporada</strong> ${liga.año_inicio || '?'} - ${liga.año_fin || '?'}
                        </div>
                        <div class="liga-detail-item" style="background: rgba(255, 255, 255, 0.05); padding: 0.75rem; border-radius: 0.25rem;">
                            <strong>País</strong> ${liga.pais || 'N/A'}
                        </div>
                        <div class="liga-detail-item" style="background: rgba(255, 255, 255, 0.05); padding: 0.75rem; border-radius: 0.25rem;">
                            <strong>Nivel</strong> ${liga.nivel || 'N/A'}
                        </div>
                       </div>
                    <p class="mt-4 text-left w-full" style="color: var(--text-secondary);">${liga.descripcion_historica || 'No hay descripción disponible.'}</p>
                     <img src="${liga.imagen_trofeo || 'https://via.placeholder.com/300x150?text=Trofeo+N/A'}"
                         alt="Trofeo de ${liga.nombre}"
                         class="liga-trofeo mt-4" style="width: 100%; max-width: 250px; height: auto; object-fit: contain; border-radius: 0.25rem; margin-top: 1rem;"
                         onerror="this.onerror=null; this.src='https://via.placeholder.com/300x150?text=Error'">
                </div>
            `;
            // Prepend the league info card before the teams grid
            equiposContainer.insertAdjacentHTML('beforebegin', ligaInfoHTML);
        }


        async function loadEquipos(ligaId) {
            // Clear previous league info card if it exists
            const existingInfoCard = document.getElementById('liga-info-card');
            if(existingInfoCard) existingInfoCard.remove();

             if (!ligaId) { /* [cite: 121] */
                 equiposContainer.innerHTML = ''; /* [cite: 121] */
                 loadingIndicator.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-8">
                         <i class="fas fa-info-circle text-4xl mb-2" style="color: var(--text-secondary);"></i>
                         <p class="text-xl" style="color: var(--text-secondary);">Selecciona una liga para ver los equipos.</p>
                     </div>`; /* [cite: 122] */
                 loadingIndicator.style.display = 'block'; /* [cite: 123] */
                 currentEquipos = []; // Clear current teams
                 return; /* [cite: 123] */
             }

            // Show loading indicator for teams
            loadingIndicator.innerHTML = `
               <div class="flex flex-col items-center justify-center py-8">
                    <i class="fas fa-spinner loading-spinner text-4xl mb-2" style="color: var(--text-secondary);"></i>
                    <p class="text-xl" style="color: var(--text-secondary);">Cargando información...</p>
                </div>`; /* [cite: 124, 125] */
            loadingIndicator.style.display = 'block'; /* [cite: 126] */
            equiposContainer.innerHTML = ''; // Clear previous teams
            currentEquipos = []; // Clear current teams

             try {
                 // 1. Fetch and render Liga Info
                const ligaResponse = await fetchWithTimeout(`${API_BASE_URL}/liga/${ligaId}`); /* [cite: 126] */
                 if (!ligaResponse.ok) { /* [cite: 127] */
                     throw new Error(`Error al cargar info de la liga: ${ligaResponse.status} ${ligaResponse.statusText}`); /* [cite: 127] */
                 }
                const ligaDataArray = await ligaResponse.json(); /* [cite: 128] */
                 if (ligaDataArray && ligaDataArray.length > 0) {
                    renderLigaInfo(ligaDataArray[0]); /* [cite: 129] */
                 } else {
                     console.warn("No se encontró información para la liga ID:", ligaId);
                 }

                // 2. Fetch Equipos
                const equiposUrl = `${API_BASE_URL}/liga/equipos/${ligaId}`; /* [cite: 130] */
                 const equiposResponse = await fetchWithTimeout(equiposUrl); /* [cite: 132] */
                 if (!equiposResponse.ok) { /* [cite: 133] */
                     let errorDetail = `Error ${equiposResponse.status}: ${equiposResponse.statusText}`; /* [cite: 133] */
                     try {
                         const errorData = await equiposResponse.json(); /* [cite: 134] */
                         errorDetail = errorData.message || errorData.error || errorDetail; /* [cite: 135] */
                     } catch (e) { /* Ignore JSON parse error */ }
                     throw new Error(errorDetail); /* [cite: 135] */
                 }
                const equiposFromServer = await equiposResponse.json(); /* [cite: 136] */

                // Basic validation/mapping
                currentEquipos = equiposFromServer.map(equipo => ({ /* [cite: 137] */
                     idEquipo: equipo.idEquipo,
                     nombre: equipo.nombre || 'Nombre Desconocido',
                     idLiga: equipo.idLiga, /* [cite: 137] */
                     ciudad: equipo.ciudad, /* [cite: 137] */
                     estadioNombre: equipo.estadioNombre, /* [cite: 138] */
                     ubicacionEstadio: equipo.ubicacionEstadio, /* [cite: 138] */
                     // descripcionHistorica: equipo.descripcionHistorica, // Not shown in card now
                     valorMercado: equipo.valorMercado || equipo.valor_mercado, /* [cite: 138] */
                     // entrenador: equipo.entrenador, // Not shown
                     // presidente: equipo.presidente, // Not shown [cite: 139]
                     logo: equipo.logo, /* [cite: 139] */
                     estadioLogo: equipo.estadioLogo || equipo.estadiologo /* [cite: 139] */
                 }));

                loadingIndicator.style.display = 'none'; /* [cite: 140] */

                 if (currentEquipos.length === 0) { /* [cite: 140] */
                     showEmptyState(ligaId, false); /* [cite: 140] */
                     return; /* [cite: 141] */
                 }

                renderEquipos(currentEquipos); /* [cite: 141] */

             } catch (error) { /* [cite: 142] */
                 console.error("Error loading liga/equipos:", error); /* [cite: 142] */
                 handleLoadError(error); /* [cite: 143] */
             }
        }


        function renderEquipos(equipos) {
            equiposContainer.innerHTML = ''; // Clear previous teams if any (but not the loading indicator)
            equipos.forEach(equipo => {
                const equipoElement = document.createElement("div");
                equipoElement.className = "card shadow-md flex flex-col"; // Reduced shadow

                const valorMercadoFormateado = equipo.valorMercado
                     ? '€' + new Intl.NumberFormat('de-DE').format(parseFloat(equipo.valorMercado))
                     : 'N/A'; /* [cite: 144] */

                equipoElement.innerHTML = `
                    <div class="flex items-center mb-4">
                        <img src="${equipo.logo || 'https://via.placeholder.com/60?text=N/A'}"
                             alt="${equipo.nombre} Logo"
                             class="team-logo rounded"
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/60?text=Error';">
                        <div class="flex-grow">
                            <h2 class="text-xl font-bold mb-1 truncate" title="${equipo.nombre}">${equipo.nombre}</h2>
                            <p class="text-sm" style="color: var(--text-secondary);">Ciudad: ${equipo.ciudad || 'N/A'}</p>
                            <p class="text-sm" style="color: var(--text-secondary);">Valor: ${valorMercadoFormateado}</p>
                        </div>
                    </div>

                    <div>
                         <img src="${equipo.estadioLogo || 'https://via.placeholder.com/400x150?text=Estadio+N/A'}"
                              alt="Estadio de ${equipo.nombre}"
                              class="stadium-logo"
                              onerror="this.onerror=null; this.src='https://via.placeholder.com/400x150?text=Error';">
                    </div>

                    <div class="action-buttons mt-auto pt-4"> <button class="btn btn-info manage-titles-btn w-full" data-id="${equipo.idEquipo}">
                             <i class="fas fa-trophy"></i> Administrar Títulos
                         </button>
                         </div>
                `; /* */ // Structure based on original, but buttons changed
                equiposContainer.appendChild(equipoElement); /* [cite: 152] */
            });

            // Add event listeners for the new "Manage Titles" buttons
            document.querySelectorAll('.manage-titles-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const equipoId = e.currentTarget.getAttribute('data-id');
                    const equipo = currentEquipos.find(e => e.idEquipo == equipoId);
                    if (equipo) {
                        openTitulosModal(equipo);
                    } else {
                        console.error("Equipo no encontrado para ID:", equipoId);
                        alert("Error: No se pudo encontrar la información del equipo seleccionado.");
                    }
                });
            });
        }

        // --- Títulos Management ---

        async function loadTitulosForTeam(equipoId) {
            titulosLoading.style.display = 'block';
            titulosListContainer.innerHTML = ''; // Clear previous
            titulosError.style.display = 'none';

            const url = `${TITULOS_API_URL_BASE}/${equipoId}`; // GET /api/equipo/titulo/:idEquipo [cite: 189]
            try {
                const response = await fetchWithTimeout(url);
                if (!response.ok) {
                     // Handle cases where the endpoint might return non-JSON or specific errors
                     let errorMsg = `Error ${response.status}: ${response.statusText}`;
                     if (response.status === 404) {
                         errorMsg = "No se encontraron títulos para este equipo o la ruta es incorrecta.";
                     } else {
                         try {
                             const errorData = await response.json();
                             errorMsg = errorData.message || errorData.error || errorMsg;
                         } catch (e) { /* ignore json parse error */ }
                     }
                    throw new Error(errorMsg);
                }
                // The endpoint returns an array where the first element is the titles array [cite: 189]
                const responseData = await response.json();
                const titulos = Array.isArray(responseData) && responseData.length > 0 && Array.isArray(responseData[0]) ? responseData[0] : [];
                // console.log("Titulos received:", titulos); // Debugging

                 renderTitulosList(titulos);

            } catch (error) {
                console.error("Error fetching titulos:", error);
                titulosError.textContent = `Error al cargar títulos: ${error.message}`;
                titulosError.style.display = 'block';
                titulosListContainer.innerHTML = '<p class="empty-state" style="padding: 1rem 0;">No se pudieron cargar los títulos.</p>';
            } finally {
                titulosLoading.style.display = 'none';
            }
        }

        function renderTitulosList(titulos) {
            titulosListContainer.innerHTML = ''; // Clear loading/empty state

            if (!titulos || titulos.length === 0) {
                titulosListContainer.innerHTML = '<p class="empty-state" style="padding: 1rem 0;">Este equipo aún no tiene títulos registrados.</p>';
                return;
            }

            titulos.forEach(titulo => {
                // Validate expected fields
                const idTitulo = titulo.idTituloEquipo;
                const nombre = titulo.nombre_titulo || 'Título Desconocido';
                const año = titulo.año || 'Año Desconocido';

                if (idTitulo === undefined) {
                    console.warn("Título omitido por falta de idTituloEquipo:", titulo);
                    return; // Skip rendering if essential ID is missing
                }

                const item = document.createElement('div');
                item.className = 'titulo-item';
                item.innerHTML = `
                    <div class="titulo-details">
                        <span class="titulo-name">${nombre}</span>
                        <span class="titulo-year">(${año})</span>
                    </div>
                    <button class="btn btn-danger titulo-delete-btn" data-id="${idTitulo}">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                titulosListContainer.appendChild(item);

                // Add delete listener
                item.querySelector('.titulo-delete-btn').addEventListener('click', async (e) => {
                    const tituloId = e.currentTarget.getAttribute('data-id');
                    if (confirm(`¿Estás seguro de que deseas eliminar el título "${nombre}" (${año})?`)) {
                         await deleteTitulo(tituloId);
                    }
                });
            });
        }

        addTituloForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            addTituloError.style.display = 'none'; // Hide previous errors

            const equipoId = tituloEquipoIdInput.value;
            const nombreTitulo = tituloNombreInput.value.trim();
            const año = tituloAñoInput.value;

            if (!equipoId || !nombreTitulo || !año) {
                showAddTituloError("Por favor, completa todos los campos.");
                return;
            }
             if (isNaN(parseInt(año)) || año < 1800 || año > 2100) {
                 showAddTituloError("Por favor, introduce un año válido (ej. 1995).");
                 return;
             }


            const tituloData = {
                 idEquipo: parseInt(equipoId), // Ensure it's a number if API requires
                 nombre_titulo: nombreTitulo, /* [cite: 192] */
                 año: parseInt(año) /* [cite: 192] */
             };

             const url = TITULOS_API_URL_BASE; // POST /api/equipo/titulo [cite: 192]
            const submitButton = addTituloForm.querySelector('button[type="submit"]');
             submitButton.disabled = true;
             submitButton.innerHTML = '<i class="fas fa-spinner loading-spinner"></i> Agregando...';


            try {
                const response = await fetchWithTimeout(url, {
                    method: 'POST', /* [cite: 192] */
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(tituloData)
                });

                if (!response.ok) {
                    let errorMsg = `Error ${response.status}: ${response.statusText}`;
                     try {
                         const errorData = await response.json();
                         errorMsg = errorData.message || errorData.error || errorMsg;
                     } catch (e) { /* ignore json parse error */ }
                    throw new Error(errorMsg);
                }

                // Success
                addTituloForm.reset(); // Clear form
                // Re-set the hidden equipo ID as reset clears it
                tituloEquipoIdInput.value = equipoId;
                 await loadTitulosForTeam(equipoId); // Reload the list

            } catch (error) {
                console.error("Error adding titulo:", error);
                showAddTituloError(`Error al agregar: ${error.message}`);
            } finally {
                 submitButton.disabled = false;
                 submitButton.innerHTML = '<i class="fas fa-plus"></i> Agregar Título';
             }
        });

         function showAddTituloError(message) {
             addTituloError.textContent = message;
             addTituloError.style.display = 'block';
         }

        async function deleteTitulo(idTituloEquipo) {
             // Use the correct base URL determined earlier
             const url = `${TITULOS_DELETE_API_URL_BASE}/${idTituloEquipo}`; // DELETE /api/equipo/titulo/:idTituloEquipo [cite: 192]
             console.log("Attempting to delete title with ID:", idTituloEquipo, "at URL:", url); // Debugging

             // Find the button to disable it
            const button = titulosListContainer.querySelector(`.titulo-delete-btn[data-id="${idTituloEquipo}"]`);
            if (button) button.disabled = true;


             try {
                 const response = await fetchWithTimeout(url, { method: 'DELETE' }); /* [cite: 192] */

                 if (!response.ok) {
                     let errorMsg = `Error ${response.status}: ${response.statusText}`;
                     try {
                         const errorData = await response.json();
                         errorMsg = errorData.message || errorData.error || errorMsg;
                     } catch (e) { /* ignore json parse error */ }
                     throw new Error(errorMsg);
                 }

                 // Successfully deleted, reload the list for the current team
                 if (currentTeamForTitles) {
                     await loadTitulosForTeam(currentTeamForTitles.idEquipo);
                 } else {
                     console.warn("No current team selected after delete operation.");
                 }

             } catch (error) {
                 console.error("Error deleting titulo:", error);
                 alert(`Error al eliminar el título: ${error.message}`);
                 // Re-enable button on error
                 if (button) button.disabled = false;

             }
        }


        // --- Error Handling & Empty States ---

        function showEmptyState(ligaId, noLigas = false) { /* [cite: 172] */
             loadingIndicator.style.display = 'none'; /* [cite: 172] */
            // Keep liga info card if it exists
            equiposContainer.innerHTML = `
                <div class="col-span-full empty-state py-12">
                    <i class="fas fa-exclamation-circle text-4xl mb-4"></i>
                    <p class="text-xl font-medium mb-4">
                        ${noLigas ? /* [cite: 173] */
                        'No hay ligas disponibles para mostrar.' : /* [cite: 174] */
                        (ligaId ? 'No se encontraron equipos en la liga seleccionada.' : 'Selecciona una liga.')} /* [cite: 174] */
                    </p>
                </div>
            `; /* [cite: 174] */
        }

        function showErrorState(message) {
            loadingIndicator.style.display = 'none';
             equiposContainer.innerHTML = `
                <div class="col-span-full error-state py-12">
                    <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                    <p class="text-xl font-medium mb-2">Error</p>
                    <p class="text-sm mb-4">${message}</p>
                </div>
            `;
        }

        function handleLoadError(error) { /* [cite: 175] */
            loadingIndicator.style.display = 'none'; /* [cite: 175] */
            // Keep league info card if it exists when showing team load errors
             let errorMessage = "Error al cargar los equipos."; /* [cite: 176] */
             let errorDetails = error.message || "Error desconocido."; /* [cite: 176] */
             if (error.name === 'AbortError') { /* [cite: 177] */
                 errorMessage = "La solicitud tardó demasiado."; /* [cite: 177] */
                 errorDetails = "Verifica tu conexión o si el servidor responde."; /* [cite: 178] */
             } else if (error.message.includes("Failed to fetch") || error.message.includes("NetworkError")) { /* [cite: 179] */
                 errorMessage = "No se pudo conectar al servidor."; /* [cite: 179] */
                 errorDetails = `Verifica la conexión y la URL base (${API_BASE_URL}).`; /* [cite: 180] */
             } else if (error.message.includes("404")) { /* [cite: 181] */
                 errorMessage = "Recurso no encontrado (404)." /* [cite: 181] */
                 errorDetails = `La URL podría ser incorrecta.` /* [cite: 182] */
             } else if (error.message.includes("500")) { /* [cite: 182] */
                 errorMessage = "Error interno del servidor (500)." /* [cite: 182] */
                 errorDetails = "Problema procesando la solicitud en el servidor." /* [cite: 183] */
             }

             equiposContainer.innerHTML = `
                <div class="col-span-full error-state py-12">
                    <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                    <p class="text-xl font-medium mb-2">${errorMessage}</p>
                    <p class="text-sm mb-4">Detalles: ${errorDetails}</p>
                    <button class="btn btn-primary" onclick="loadEquipos(currentLigaId)">
                         <i class="fas fa-sync-alt"></i>Reintentar
                    </button>
                </div>
            `; /* [cite: 184, 185] */
        }

        // --- Initialization ---
        document.addEventListener("DOMContentLoaded", async () => { /* [cite: 186] */
            setupThemeToggle(); /* [cite: 186] */
            setupModals(); /* [cite: 186] */

            await loadLigasForSelect(); /* [cite: 186] */

            ligaSelect.addEventListener('change', () => { /* [cite: 187] */
                 currentLigaId = ligaSelect.value; /* [cite: 187] */
                 loadEquipos(currentLigaId); /* [cite: 187] */
            });

            document.getElementById('current-year').textContent = new Date().getFullYear(); /* [cite: 187] */
        }); /* [cite: 188] */

    </script>
</body>
</html>